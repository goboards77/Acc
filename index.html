<!DOCTYPE html><html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gopal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">  
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
</head>
<body class="h-screen p-2 bg-[radial-gradient(circle_at_70%_20%,#d428a3,#003366)]" style="font-family: 'Roboto'; font-size: 18px;">
<button id="topBar"class="hidden w-full z-50 text-left text-white px-5 py-3 h-12 fixed top-0 left-0" onclick="showCont('menuCont')">‚ò∞ Start Here</button>
<div id="menuCont" class="hidden text-white w-full max-w-md p-2 mt-12 rounded-lg border-2 border-green-500"> <!-- bg-[radial-gradient(circle_at_70%_20%,#d428a3,#003366)]-->
    <button class="btnDD" onclick="showCont('createCont')">Create</button>
    <button class="btnDD" onclick="showCont('updCont')">Alter</button>
    <button class="btnDD" onclick="showCont('finCont')">Financials</button>
    <button class="btnDD" onclick="showCont('rptCont')">Report</button>
    <button class="btnDD" onclick="logout()">Logout</button>
    <button class="btnDD" onclick="showCont()">Home</button>
</div>

<div id ="createCont" class="hidden w-full max-w-md text-white p-2 mt-12 rounded-lg border-2 border-green-500"> <!-- bg-[radial-gradient(circle_at_70%_20%,#d428a3,#003366)]-->
    <button id=1 class="btnDD" onclick="changeLists()">Ledger</button>
    <button id=2 class="btnDD" onclick="changeLists()">Product</button>
    <button id=3 class="btnDD" onclick="showEle(301,302,303,304,305,306,307,3010)">Transaction</button>
</div>
<div id ="updCont" class="hidden w-full max-w-md text-white p-2 mt-12 rounded-lg border-2 border-green-500"> <!-- bg-[radial-gradient(circle_at_70%_20%,#d428a3,#003366)]-->
    <button id=11 class="btnDD" onclick="insertProdLed('Opening Balance', false)">Update Ledger</button>
    <button id=12 class="btnDD" onclick="insertProdLed('Opening Stock', false)">Update Product</button>
    <button id=13 class="btnDD" onclick="insertTran(true, true, false, false)">Update Transaction</button>
</div>
<div id ="finCont" class="hidden w-full max-w-md text-white p-2 mt-12 rounded-lg border-2 border-green-500"> <!-- bg-[radial-gradient(circle_at_70%_20%,#d428a3,#003366)]-->
    <button id=21 class="btnDD" onclick="viewSummary('receivables')">Receivables</button>
    <button id=22 class="btnDD" onclick="viewSummary('payables')">Payables</button>
    <button id=23 class="btnDD" onclick="showCont('plCont')">Profit & Loss</button>
    <button id=25 class="btnDD" onclick="alert('Under Construction! Coming Soooooooon')">Khatavahi</button>
</div>
<div id ="rptCont" class="hidden w-full max-w-md text-white p-2 mt-12 rounded-lg border-2 border-green-500"> <!-- bg-[radial-gradient(circle_at_70%_20%,#d428a3,#003366)]-->
    <button id=31 class="btnDD" onclick="insertTran(false, false, false, false)">Daybook</button>
    <button id=32 class="btnDD" onclick="insertTran(false, false, false, true)">CashBook</button>
    <button id=33 class="btnDD" onclick="viewSummary('sales')">Sales Register</button>
    <button id=34 class="btnDD" onclick="viewSummary('purchase')">Purchase Register</button>
    <button id=35 class="btnDD" onclick="insertProdLed('Opening Balance', true)">Ledgers & Groups</button>
    <button id=36 class="btnDD" onclick="insertProdLed('Opening Stock', true)">Products & Groups</button>
    <button id=37 class="btnDD" onclick="showDashboard()">Dashboard</button>
</div>
<div id ="eleCont" class="hidden w-full max-w-md p-2 mt-12 text-white rounded-lg border-2 border-green-500"> <!-- bg-[radial-gradient(circle_at_80%_10%,#0b41e0,#f0717b)]-->
    <input id=101 class="input-box" type="text"/><label class="label">Select Group</label>
    <input id=102 class="input-box" type="text"/><label class="label">Name</label>
    <input id=103 class="input-box" type="number"/><label class="label">Opening Balance/Stock</label>
    <input id=104 class="input-box" type="text"/><label class="label">Credit/Debit</label>
    <input id=105 class="input-box mb-[50px]" type="text"/><label class="label">Narration</label>

    <input id=301 class="input-box" type="text"/><label class="label">Transaction Type</label>
    <input id=302 class="input-box date-input" type="text"/><label class="label">Date</label>
    <input id=303 class="input-box" type="text"/><label class="label">From</label>
    <input id=304 class="input-box" type="text"/><label class="label">To</label>
    <input id=305 class="input-box" type="number"/><label class="label">Amount</label>
    <input id=306 class="input-box mb-[50px]" type="text"/><label class="label">Narration</label>
</div>
<div id=1010 class="hidden p-2 mt-2 w-fit rounded-full h-[65px] space-x-[78px] bg-[radial-gradient(circle_at_60%_20%,#5eead4,#003366)]">
    <button class="btnSV" onclick="saveProdLed()">üíæ</button>
    <button class="btnSV" title="Back" onclick="alert('Under Construction üèóÔ∏è\nBy\nL&T üë∑üèº')">‚û§</button>
</div>
<div id=3010 class="hidden p-2 mt-2 w-fit rounded-full h-[65px] space-x-[78px] bg-[radial-gradient(circle_at_60%_30%,#5eead4,#003366)]">
    <button class="btnSV" onclick="saveTransaction()">üíæ</button>
    <button class="btnSV" title="View Daybook" onclick="insertTran(true, true, false)">üìñ</button>
</div>
<div id="plCont" class="hidden w-fit mt-[50px] flex items-center gap-2 p-1 rounded-lg border border-green-600">
    <input id="clostk" type="number" placeholder="Closing Stock" class="border border-green-600 rounded px-2 h-10 w-50 inline-block" />
    <button onclick="profit_loss()" title="view profit_loss" class="inline-flex w-10 h-10 rounded-full items-center justify-center ring-green-500 hover:ring-4 transition">üîç</button>
    <div id="plLabels" class="max-w-md mx-auto mt-4 border rounded-lg divide-y"></div>
</div>

<div id="tblCont" class="hidden w-fit mt-[50px] rounded-lg p-1 space-y-2 border border-green-600">
    <div><input id="searchBox" class="w-fit px-2 h-10 border border-green-600 rounded" placeholder="Search..." type="text" autocomplete="off"/></div>
    <div class="w-fit flex gap-8 ml-5 justify-start">
        <button id="excelBtn" class="w-10 h-10 flex text-white items-center justify-center rounded-full ring-green-500 hover:ring-4 transition">XL</button>
        <button id="pdfBtn" class="w-10 h-10 flex text-white items-center justify-center rounded-full ring-green-500 hover:ring-4 transition">PDF</button>
        <button id="printBtn" class="w-10 h-10 flex items-center justify-center rounded-full ring-green-500 hover:ring-4 transition">üñ®Ô∏è</button>
    </div>
    <div id="table" class="rounded-lg border border-green-600 mx-auto text-[18px] font-[Roboto]"></div>
</div>

<div id="dashboard" class="hidden w-full max-w-md mt-[50px] ml-1 text-white"><h2>Dashboard</h2><canvas id="dashboardChart"></canvas></div>

<div id="lgnCont" class="hidden max-w-md p-2 mt-[50px] rounded bg-white">
    <input class="input-box" id="loginEmail" type="email" /><label for="loginEmail" class="label">Email</label>
    <input class="input-box" id="loginPassword" type="password" /><label for="loginPassword" class="label">Password</label>
    <button class="btnSV block mx-auto mt-5" title="Login" onclick="login()">üè†Ô∏é</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script><script> flatpickr(".date-input", { dateFormat: "d-m-Y", defaultDate: new Date() }); </script>
<script type="module">
    import {initializeApp} 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,} 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {getFirestore, collection, getDocs, getDoc, setDoc, deleteDoc, doc, updateDoc, query, where, addDoc, writeBatch, deleteField} 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    const firebaseConfig = {
        apiKey: "AIzaSyBTzC8wOFu37dS-qoRCbqidIomPfJxL9TA",
        authDomain: "accounting-6cf0a.firebaseapp.com",
        projectId: "accounting-6cf0a",
        storageBucket: "accounting-6cf0a.firebasestorage.app",
        messagingSenderId: "837947129929",
        appId: "1:837947129929:web:021b2b5bab2bf889aa7f98" 
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const groupNames = ["Cash", "Bank", "Creditors", "Debitors", "Angadiya", "Expense", "Sproducts", "Pproducts"];
    let currentDocId = null, cachedData = null;
    onAuthStateChanged(auth, async (user) => {
        if (user) { 
            const docRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) { const dbName = docSnap.data().db; window.tranCol = collection(db, dbName); };
            showCont('topBar'); await fetchAllOnce(); await loadDropdownData(); 
        } else { document.getElementById("topBar").classList.add("hidden"); showCont("lgnCont"); } 
    });   

    window.createAndDeduplicateDocuments = async function () {
        for (const groupName of groupNames) {
            const data = { grp: groupName, ttype: "Group" };
            const q = query(tranCol, where("grp", "==", groupName), where("ttype", "==", "Group"));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { await addDoc(tranCol, data); } 
        } 
    };

    document.addEventListener('DOMContentLoaded', () => {
        const wrapperClass = "relative mt-6";
        const inputClass = "peer w-full bg-transparent border-b-2 border-gray-400 pt-2 focus:outline-none focus:border-green-600";
        const labelClass = "absolute top-2 left-0 -translate-y-6 peer-placeholder-shown:translate-y-0 peer-focus:text-green-600 text-gray-400";

        document.querySelectorAll('.input-box').forEach(input => {
            const label = input.nextElementSibling;
            if (!label || label.tagName !== "LABEL") return;

            const wrapper = document.createElement("div");
            wrapper.className = wrapperClass;
            input.parentNode.insertBefore(wrapper, input);
            wrapper.appendChild(input);
            wrapper.appendChild(label);

            input.classList.add(...inputClass.split(' '));
            label.classList.add(...labelClass.split(' '));
            input.setAttribute("placeholder", " ");
            input.setAttribute("autocomplete", "off");

            if (input.type === "text") {
                input.addEventListener('input', function () {
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    this.value = this.value.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
                    this.setSelectionRange(start, end); 
                }); 
            }
        });
    });

    const btnClass1 = "block w-full max-w-md px-2 py-3 text-left cursor-pointer hover:bg-blue-600 hover:text-white rounded";
    document.querySelectorAll('.btnDD').forEach(btn => { btn.classList.add(...btnClass1.split(' ')); });
    const btnClass2 = "w-[50px] h-[50px] rounded-full text-white text-[20px] font-bold bg-[radial-gradient(circle_at_25%_20%,#6dd5fa,#003366)] shadow-[0_8px_15px_rgba(0,0,0,0.4)] transition-transform duration-500 hover:scale-125 hover:shadow-[0_12px_25px_rgba(0,0,0,0.6)]";
    document.querySelectorAll('.btnSV').forEach(btn => { btn.classList.add(...btnClass2.split(' ')); });
    
    window.showEle = function (...ids) {
        showCont('eleCont')
        const cont = document.getElementById("eleCont");
        Array.from(cont.children).forEach(child  => child.style.setProperty('display', 'none', 'important'));
        let firstFocusable = null;
        ids.forEach(id => {
            let el = document.getElementById(id);
            if (el) { 
                if (el.tagName === "INPUT" || el.tagName === "LABEL") { el = el.parentElement;}
                el.style.setProperty('display', 'block', 'important');
                if (!firstFocusable) { firstFocusable = el.querySelector("input, select, textarea, button"); }
            }
        });
        if (firstFocusable) { requestAnimationFrame(() => { firstFocusable.focus(); }); }
    };

    window.clear = function () {
        document.querySelectorAll("input").forEach(el => { if (el.id !== "date") { el.value = ""; } });
        loadDropdownData(); document.getElementById("301").disabled = false;
    };

    window.showCont = function (...idToShow) {
        const allIds = ['menuCont', 'createCont', 'updCont', 'finCont', 'rptCont', 'eleCont', '1010', '3010', 'plCont', 'tblCont', 'dashboard', 'lgnCont'];
        allIds.forEach(id => { clear(); const el = document.getElementById(id); if (el) { el.classList.add("hidden"); el.style.setProperty('display', 'none', 'important'); } });
        idToShow.forEach(id => { const el = document.getElementById(id); if (el) { el.classList.remove("hidden"); el.style.setProperty('display', 'block', 'important'); } }); 
    };

    window.fetchAllOnce = async function () { 
        if (cachedData) { return cachedData; } 
        const snapshot = await getDocs(tranCol);
        cachedData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
        return cachedData; 
    };
    
    window.loadDropdownData = async function () {
        const transactionsData = await fetchAllOnce();
        const nameSet = new Set();
        const sproductSet = new Set();
        const pproductSet = new Set();
        const crdbSet = new Set();
        const crdbcsbkangSet = new Set();
        const crdbcsbkangexpSet = new Set();

        transactionsData.forEach((item) => {
            const grp = (item.grp || "").trim();
            const name = (item.name || "").trim();
            if (name.length > 0) {nameSet.add(name);}
            if (grp === "Sproducts" && name.length > 0) {sproductSet.add(name);}
            if (grp === "Pproducts" && name.length > 0) {pproductSet.add(name);}
            if (["Creditors", "Debitors"].includes(grp) && name.length > 0) {crdbSet.add(name);}
            if (["Creditors", "Debitors", "Cash", "Bank", "Angadiya",].includes(grp) && name.length > 0) {crdbcsbkangSet.add(name);}
            if (["Creditors", "Debitors", "Cash", "Bank", "Angadiya", "Expense"].includes(grp) && name.length > 0) {crdbcsbkangexpSet.add(name);} 
        });

        window.names_list = [...nameSet].sort((a, b) => a.localeCompare(b));
        window.sproduct_list = [...sproductSet].sort((a, b) => a.localeCompare(b));
        window.pproduct_list = [...pproductSet].sort((a, b) => a.localeCompare(b));
        window.crdb_list = [...crdbSet].sort((a, b) => a.localeCompare(b));
        window.crdbcsbkang_list = [...crdbcsbkangSet].sort((a, b) => a.localeCompare(b));
        window.crdbcsbkangexp_list = [...crdbcsbkangexpSet].sort((a, b) => a.localeCompare(b)); 
        attachDropdown(document.getElementById("104"), ["Credit", "Debit"]);
        attachDropdown(document.getElementById("301"), ["Sales", "Purchase", "Receipt", "Payment"]);
    };
    window.attachDropdown = function (inputElement, dataList) {
        if (inputElement._dropdownCleanup) { inputElement._dropdownCleanup(); }
        let wrapper = inputElement.parentElement;
        if (!wrapper.classList.contains("relative")) {
            wrapper = document.createElement("div");
            wrapper.className = "relative w-full";
            inputElement.parentNode.insertBefore(wrapper, inputElement);
            wrapper.appendChild(inputElement);
        }
        let dropdown = document.createElement("ul");
        dropdown.className = "absolute z-50 w-full h-[500px] overflow-y-auto hidden rounded-b bg-[radial-gradient(circle_at_80%_20%,#b34515,#096103)]";
        wrapper.appendChild(dropdown);
        function filterList() {
            const search = inputElement.value.toLowerCase();
            const matches = dataList.filter(item => item.toLowerCase().includes(search));
            populateDropdown(matches);
        }
        function populateDropdown(list) {
            dropdown.innerHTML = "";
            list.forEach(item => {
                const btn = document.createElement("button");
                btn.textContent = item;
                btn.className = "block w-full max-w-md px-2 py-3 text-left cursor-pointer hover:bg-blue-600 hover:text-white border-b border-gray-400 last:border-b-0";
                btn.addEventListener('click', () => { inputElement.value = item; dropdown.classList.add("hidden"); if (inputElement.id === "301") { changeLists(); } }); 
                dropdown.appendChild(btn);
            });
        }
        const onInput = () => { dropdown.classList.remove("hidden"); filterList(); };
        const onClick = () => { dropdown.classList.remove("hidden"); filterList(); };
        const onBlur = () => {
            setTimeout(() => {
                const value = inputElement.value.trim().toLowerCase();
                if (value && !dataList.some(item => item.toLowerCase() === value)) { alert("Please select a valid option from the list. üö´"); inputElement.value = ""; return; } }, 200);
        };
        const onDocClick = (e) => { if (!wrapper.contains(e.target)) dropdown.classList.add("hidden"); };
        inputElement.addEventListener("input", onInput);
        inputElement.addEventListener("click", onClick);
        inputElement.addEventListener("blur", onBlur);
        document.addEventListener("click", onDocClick);

        inputElement._dropdownCleanup = () => {
            inputElement.removeEventListener("input", onInput);
            inputElement.removeEventListener("click", onClick);
            inputElement.removeEventListener("blur", onBlur);
            document.removeEventListener("click", onDocClick);
            if (dropdown.parentNode) dropdown.parentNode.removeChild(dropdown);
            inputElement._dropdownCleanup = null;
        };
    };    
    window.createEditableTable = function (rows, columns, showDelete = true, showUpdate = true, editable = false) {
        if (window.table && typeof window.table.destroy === "function") window.table.destroy();
        const isMobile = window.innerWidth < 768;  
        const searchId = document.getElementById('searchBox');
        let fullColumns = columns.map(col => {
            if (isMobile && col.field === "id") return { ...col, visible: false };
            return { ...col, editor: editable ? col.editor || "input" : false };
        });

        if (!isMobile) {
            if (showDelete) {
                fullColumns.push({
                    title: "",
                    field: "__delete",
                    formatter: () => `<div class="text-center cursor-pointer">‚õî</div>`,
                    width: 70,
                    hozAlign: "center",
                    cellClick: async (e, cell) => {
                        e.stopPropagation();
                        const rowData = cell.getRow().getData();
                        const confirmed = confirm("Delete? Are You Sure?");
                        if (confirmed && rowData.id) {
                            await deleteDoc(doc(tranCol, rowData.id));
                            cell.getRow().delete();
                            if (cachedData) cachedData = cachedData.filter(doc => doc.id !== rowData.id);
                        }
                    },
                });
            }

            if (showUpdate) {
                fullColumns.push({
                    title: "",
                    field: "__update",
                    formatter: () => `<div class="text-center cursor-pointer">‚úèÔ∏è</div>`,
                    width: 70,
                    hozAlign: "center",
                    cellClick: (e, cell) => {
                        e.stopPropagation();
                        const rowData = cell.getRow().getData();
                        currentDocId = rowData.id;
                        showTransactionContainer(rowData);
                    },
                });
            }
        }

        window.table = new Tabulator(document.getElementById('table'), {
            data: rows,
            layout: "fitDataTable",
            reactiveData: true,
            rowHeight: 40,
            maxHeight: "600px",
            headerVisible: !isMobile,
            columns: fullColumns,
            rowFormatter: isMobile ? function (row) {
                row.getElement().style.display = "block";
                let d = row.getData();
                let card = document.createElement("div");
                card.className = `w-full max-w-md bg-white grid grid-cols-[100px_1fr] mb-1 text-[18px] font-[Roboto] rounded-lg border border-green-500`;

                let inner = "";
                columns.forEach(col => {
                    if (col.field !== "__delete" && col.field !== "__update") {
                        const val = d[col.field];
                        if (val !== undefined && val !== null && val !== "") { inner += ` <div class="text-gray-600 text-right px-1">${col.title}:</div> <div class="text-gray-900 px-1">${val}</div> `; }
                    }
                });

                if (showDelete || showUpdate) {
                    inner += `<div class="col-span-2 pb-2 pr-5 flex justify-end gap-20 rounded-lg">`;
                    if (showDelete) inner += `<span class="delete-btn cursor-pointer">‚õî</span>`;
                    if (showUpdate) inner += `<span class="update-btn cursor-pointer">‚úèÔ∏è</span>`;
                    inner += `</div>`;
                }

                card.innerHTML = inner;
                row.getElement().innerHTML = "";
                row.getElement().appendChild(card);

                if (showDelete) {
                    card.querySelector(".delete-btn")?.addEventListener("click", async (e) => {
                        e.stopPropagation();
                        const confirmed = confirm("Delete? Are You Sure?");
                        if (confirmed && d.id) {
                            await deleteDoc(doc(tranCol, d.id));
                            row.delete();
                            if (cachedData) cachedData = cachedData.filter(doc => doc.id !== d.id);
                        }
                    });
                }

                if (showUpdate) {
                    card.querySelector(".update-btn")?.addEventListener("click", (e) => {
                        e.stopPropagation();
                        currentDocId = d.id;
                        showTransactionContainer(d);
                    });
                }
            } : undefined
        });

        document.getElementById('excelBtn')?.addEventListener("click", () => { window.table.download("xlsx", "data.xlsx", { sheetName: "Sheet1" }); });
        document.getElementById('pdfBtn')?.addEventListener("click", () => { window.table.download("pdf", "data.pdf", { orientation: "portrait" }); });
        document.getElementById('printBtn')?.addEventListener("click", () => { window.table.print(false, true); });
        bindSearch(); showCont("tblCont");
    };    
    window.bindSearch = function () {
        const searchbox = document.getElementById("searchBox");
        searchbox.addEventListener("input", function () {
            const value = this.value.toLowerCase().trim();
            table.setFilter(function (data) {
                if (value === "") { return true; }
                return Object.values(data).some(val => String(val).toLowerCase().includes(value)); 
            }); 
        }); 
    };
    window.showTransactionContainer = function (rowData) { 
        const type = (rowData.ttype || "").trim();
        document.getElementById("tblCont").classList.add("hidden");
        document.querySelectorAll("input:not(#ttype)").forEach(el => el.value = "");
        showCont('eleCont');
        switch (type) {
            case "Opening Balance":
            case "Opening Stock":
                showEle(101,102,103,104,105,1010);
                document.getElementById("101").value = rowData.grp || "";
                document.getElementById("102").value = rowData.name || "";  
                document.getElementById("103").value = rowData.amt || "";
                document.getElementById("104").value = rowData.baltype || "";
                document.getElementById("105").value = rowData.nar || "";
                break;
            case "Sales":
            case "Purchase":
            case "Receipt":
            case "Payment":
                showEle(301,302,303,304,305,306,3010);
                document.getElementById("301").value = rowData.ttype || "";
                document.getElementById("302").value = rowData.date || "";
                document.getElementById("303").value = rowData.fparty || "";
                document.getElementById("304").value = rowData.tparty || "";
                document.getElementById("305").value = rowData.amt || "";
                document.getElementById("306").value = rowData.nar || "";
                break;
        }
        document.getElementById("301").disabled = true;
        changeLists(); 
    };
    window.changeLists = function () {
        const text = event.target.textContent;
        if (text === "Ledger") {showEle(101,102,103,104,105,1010); attachDropdown(document.getElementById("101"), ["Angadiya", "Bank", "Cash", "Creditors", "Debitors", "Expense"]);}
        if (text === "Product") {showEle(101,102,103,104,105,1010); attachDropdown(document.getElementById("101"), ["Sproducts", "Pproducts"]);}
    
        if (document.getElementById("301").value === "Sales") {
            attachDropdown(document.getElementById("303"), window.sproduct_list);
            attachDropdown(document.getElementById("304"), window.crdb_list);
        } else if (document.getElementById("301").value === "Purchase") {
            attachDropdown(document.getElementById("303"), window.crdb_list);
            attachDropdown(document.getElementById("304"), window.pproduct_list);
        } else if (document.getElementById("301").value === "Receipt" || document.getElementById("301").value === "Payment") {
            attachDropdown(document.getElementById("303"), window.crdbcsbkang_list);
            attachDropdown(document.getElementById("304"), window.crdbcsbkangexp_list); 
        }
     };
    window.insertTran = async function (showDelete = true, showUpdate = true, editable = false, filterCashGroup = false) {
        const allData = await window.fetchAllOnce();
        const cashNames = new Set();
        const rows = [];
        if (filterCashGroup) { allData.forEach((data) => { if ((data.grp || "").trim() === "Cash") { cashNames.add((data.name || "").trim()); } }); };        
        
        allData.forEach((data) => {
            const ttype = (data.ttype || "").trim();
            const date = (data.date || "").trim();
            if (ttype === "Group" || !date) return;
            if (filterCashGroup) { if (!cashNames.has((data.fparty || "").trim()) && !cashNames.has((data.tparty || "").trim())) { return; } }

            rows.push({
                id: data.id,
                date: date.split('-').reverse().join('-').replace(/(\d{2})-(\d{4})$/, '$1-$2'),
                ttype: ttype,
                fparty: data.fparty || "",
                tparty: data.tparty || "",
                nar: data.nar || "",
                amt: data.amt || "", 
            }); 
        });
        const columns = [
            {title: "Type", field: "ttype"}, 
            {title: "Date", field: "date"}, 
            {title: "From Party", field: "fparty"}, 
            {title: "To Party", field: "tparty"}, 
            {title: "Narration", field: "nar"}, 
            {title: "Amount", field: "amt", hozAlign: "right"}, 
        ];
        createEditableTable(rows, columns, showDelete, showUpdate, editable);
    };

    window.saveTransaction = async function () { 
        const ttype = document.getElementById("301").value.trim();
        const odate = document.getElementById("302");
        const date = odate._flatpickr.formatDate(odate._flatpickr.parseDate(odate.value.trim(), "d-m-Y"), "Y-m-d");
        const fparty = document.getElementById("303").value.trim();
        const tparty = document.getElementById("304").value.trim();
        const amt = parseFloat(document.getElementById("305").value.trim()) || 0;
        const nar = document.getElementById("306").value.trim();
        
        if (!ttype || !date || !fparty || !tparty || isNaN(amt) || amt <= 0) { alert("Please fill all required fields properly\nAmount must be a number > 0"); return ; }
        const tranData = {ttype, date, fparty, tparty, amt};
        if (nar) tranData.nar = nar;
        if (currentDocId) {
            const docRef = doc(tranCol, currentDocId); 
            await updateDoc(docRef, tranData);
            const index = cachedData.findIndex(item => item.id === docRef.id);
            if (index !== -1) { cachedData[index] = { ...cachedData[index], ...tranData }; }
        } else {
            const newDocRef = await addDoc(tranCol, tranData); 
            cachedData.push({ id: newDocRef.id, ...tranData });
        }
        clear(); currentDocId = null; 
    };

    window.insertProdLed = async function (type, viewOnly = false) {
        const allData = await window.fetchAllOnce();
        const rows = [];
        allData.forEach((data) => { if (data.ttype === type) { rows.push({ id: data.id, ttype: data.ttype, amt: data.amt || "", nar: data.nar || "", name: data.name || "", grp: data.grp || "", }); }; });
        const columns = [ {title: "Group", field: "grp"}, {title: "Name", field: "name"}, {title: "Amount", field: "amt", hozAlign: "right"}, {title: "Narration", field: "nar"}, ];
        createEditableTable(rows, columns, false, !viewOnly, false);
    };

    window.saveProdLed = async function () {
        let amt, oldName = null;
        const isProductGroup = (g) => g === "Sproducts" || g === "Pproducts";
        const group = document.getElementById("101").value.trim();
        const newName = document.getElementById("102").value.trim();
        const amtValue = document.getElementById("103").value.trim();
        const balType = document.getElementById("104").value.trim();
        const nar = document.getElementById("105").value.trim(); 
        
        const docId = currentDocId;
        if (!group || !newName) { return alert("Group and Name are required. üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ üßæ"); }
        if (amtValue.trim() !== "") { if (balType !== "Credit" && balType !== "Debit") { return alert("If amount is entered, Balance Type must be Credit or Debit. üí∞"); } }

        if (docId) { const existingDoc = cachedData.find(d => d.id === docId); oldName = existingDoc ? existingDoc.name : ""; }
        if (!docId || (docId && newName !== oldName)) {
            const exists = cachedData.some(d => d.name === newName);
            if (exists) { return alert(`A ${type === "product" ? "product" : "ledger"} with this name already exists. üëØ‚Äç‚ôÄÔ∏è üßæ`); }
        }

        let ttype = isProductGroup(group) ? "Opening Stock" : "Opening Balance";
        const assignPartyFields = (dataObj) => {
            if (amt !== undefined) { 
                dataObj.amt = amt;
                if (balType === "Credit") { dataObj.fparty = newName; } 
                else if (balType === "Debit") { dataObj.tparty = newName; } 
            } 
        };

        if (docId) {
            const updateObj = { grp: group, name: newName, ttype: ttype };
            if (amt !== undefined) updateObj.amt = amt;
            updateObj.nar = nar ? nar : deleteField();

            if (balType === "Credit") { updateObj.fparty = newName; updateObj.tparty = deleteField(); } 
            else if (balType === "Debit") { updateObj.tparty = newName; updateObj.fparty = deleteField(); } 
            else { updateObj.fparty = deleteField(); updateObj.tparty = deleteField(); }

            await updateDoc(doc(tranCol, docId), updateObj);
            const idx = cachedData.findIndex(d => d.id === docId);
            if (idx !== -1) { cachedData[idx] = { ...cachedData[idx], ...updateObj }; }

            const batch = writeBatch(db);
            cachedData.forEach((data) => {
                const updates = {};
                let shouldUpdate = false;
                if (data.fparty === oldName) { updates.fparty = (balType === "Credit" || isProductGroup(group)) ? newName : deleteField(); shouldUpdate = true; }
                if (data.tparty === oldName) { updates.tparty = (balType === "Debit") ? newName : deleteField(); shouldUpdate = true; }
                if (shouldUpdate) { batch.update(doc(tranCol, data.id), updates); Object.assign(data, updates); }
            });
            await batch.commit();
        } else {
            const newDocData = { grp: group, name: newName, ttype: ttype };
            if (nar) newDocData.nar = nar;
            assignPartyFields(newDocData);
            if (balType === "Credit" || balType === "Debit") newDocData.baltype = balType;
            const docRef = await addDoc(tranCol, newDocData);
            cachedData.push({ id: docRef.id, ...newDocData });
        }
        clear();
        currentDocId = null; 
    };

    window.viewSummary = async function (mode = "receivables") {
        const allData = await fetchAllOnce();
        const ledgerGroups = {};
        const balances = {};

        allData.forEach((data) => {
            const name = (data.name || "").trim();
            const grp = (data.grp || "").trim();
            if (name && grp) { ledgerGroups[name] = grp; }
            if (["receivables", "payables"].includes(mode)) {
                if (data.fparty) { const party = data.fparty.trim(); balances[party] = (balances[party] || 0) + parseFloat(data.amt || "0"); }
                if (data.tparty) { const party = data.tparty.trim(); balances[party] = (balances[party] || 0) - parseFloat(data.amt || "0"); }
            } 
            else if (["sales", "purchase"].includes(mode)) { ["fparty", "tparty"].forEach(key => { if (data[key]) { const party = data[key].trim(); balances[party] = (balances[party] || 0) + parseFloat(data.amt || "0"); } }); }
        });
        let rows = [], total = 0, firstColTitle = "Party";
        if (["receivables", "payables"].includes(mode)) {
            const isReceivable = mode === "receivables";
            const allowedGroups = ["Creditors", "Debitors", "Bank", "Angadiya", "Cash"];

            for (const [party, amount] of Object.entries(balances)) {
                const grp = ledgerGroups[party];
                if (grp && allowedGroups.includes(grp)) {
                    const isValid = (isReceivable && amount < 0) || (!isReceivable && amount > 0);
                    if (isValid) { const absAmt = Math.abs(amount); rows.push({ party, amount: absAmt.toFixed(0) }); total += absAmt; }
                }
            }
        } 
        else {
            const isSales = mode === "sales";
            const targetGroup = isSales ? "Sproducts" : "Pproducts";
            firstColTitle = "Products";

            Object.entries(balances).forEach(([party, amount]) => {
                const grp = ledgerGroups[party];
                if (amount && grp === targetGroup) { total += Number(amount); rows.push({ party, amount: Number(amount).toFixed(0) }); }
            });
        }
        rows.sort((a, b) => Number(b.amount) - Number(a.amount));
        rows.unshift({ party: ["sales", "purchase"].includes(mode) ? (mode === "sales" ? "Sales Total" : "Purchase Total") : "Total", amount: total.toFixed(0) });
        const columns = [ { title: firstColTitle, field: "party" }, { title: "Amount", field: "amount", hozAlign: "right" } ];
        createEditableTable(rows, columns, false, false, false); 
    };

    window.profit_loss = async function () {
        const closingStock = parseFloat(document.getElementById("clostk").value.trim()) || 0;
        const allData = await fetchAllOnce();
        let totalPurchase = 0, totalExpense = 0, totalSales = 0, OpeningStock = 0;

        allData.forEach((data) => {
            const amount = parseFloat(data.amt || 0);
            const ttype = (data.ttype || "").trim();
            if (ttype === "Opening Stock") { OpeningStock += amount; }
            else if (ttype === "Purchase") { totalPurchase += amount; } 
            else if (ttype === "Expense") { totalExpense += amount; } 
            else if (ttype === "Sales") { totalSales += amount; } 
        });

        const debitTotal = OpeningStock + totalPurchase + totalExpense;
        const creditTotal = totalSales + closingStock;
        const profit = creditTotal - debitTotal;

        document.getElementById("plLabels").innerHTML = `
            <div class="flex justify-between px-3 py-1 text-white"><span>Opening Stock</span><span>${OpeningStock.toFixed(0)}</span></div>
            <div class="flex justify-between px-3 py-1 text-white"><span>Purchase</span><span>${totalPurchase.toFixed(0)}</span></div>
            <div class="flex justify-between px-3 py-1 text-white"><span>Expense</span><span>${totalExpense.toFixed(0)}</span></div>
            <div class="flex justify-between px-3 py-1 text-white font-semibold"><span>Total (Op + Pur + Exp)</span><span>${debitTotal.toFixed(0)}</span></div>
            <div class="flex justify-between px-3 py-1 text-white"><span>Sales</span><span>${totalSales.toFixed(0)}</span></div>
            <div class="flex justify-between px-3 py-1 text-white"><span>Closing Stock</span><span>${closingStock.toFixed(0)}</span></div>
            <div class="flex justify-between px-3 py-1 text-white font-semibold"><span>Total (Sales + Clo)</span><span>${creditTotal.toFixed(0)}</span></div>
            <div class="flex justify-between px-3 py-1 font-bold ${profit>=0 ? 'text-green-300' : 'text-red-300'}"><span>Profit / Loss</span><span>${profit.toFixed(0)}</span></div>
        `;
    };

    window.showDashboard = async function () {
        showCont("dashboard");
        const allData = await fetchAllOnce();
        const monthlyData = {};

        allData.forEach((data) => {
            const jsDate = new Date(data.date);
            if (isNaN(jsDate)) return;
            const month = jsDate.toLocaleString('default', { month: 'short' });
            if (!monthlyData[month]) { monthlyData[month] = { sales: 0, purchase: 0, expense: 0 }; }
            const ttype = (data.ttype || "").trim().toLowerCase();
            if (ttype === "sales") { monthlyData[month].sales += parseFloat(data.amt || 0); } 
            if (ttype === "purchase") { monthlyData[month].purchase += parseFloat(data.amt || 0); } 
            if (ttype === "expense") { monthlyData[month].expense += parseFloat(data.amt || 0); } 
        });

        const monthOrder = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const labels = Object.keys(monthlyData).sort( (a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b) );
        const sales = labels.map(m => monthlyData[m].sales);
        const purchase = labels.map(m => monthlyData[m].purchase);
        const textColor = "white"

        if (window.dashboardChart instanceof Chart) { window.dashboardChart.destroy(); }
        window.dashboardChart = new Chart(document.getElementById("dashboardChart"), {
            type: 'bar',
            data: { labels, datasets: [ { label: "Sales", data: sales, backgroundColor: "rgba(75, 192, 192, 0.6)" }, { label: "Purchase", data: purchase, backgroundColor: "rgba(255, 159, 64, 0.6)" } ] }, 
            options: { 
                responsive: true, 
                plugins: { legend: { labels: { color: textColor } }, datalabels: { anchor: 'end', align: 'start', formatter: value => value.toLocaleString(), font: { weight: 'bold' }, color: textColor } },  
                scales: { x: { ticks: { color: textColor } }, y: { beginAtZero: true, ticks: { color: textColor } } } 
            }, 
        }); 
    };
   
    window.logout = async function () { showCont(); if (confirm("Are you sure you want to logout?")) { await signOut(auth); showCont("lgnCont"); } };

    window.login = async function () {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const docRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists() && docSnap.data().approved === true) { showCont("topBar"); }
    };

    //window.addEventListener("beforeunload", function (e) { e.preventDefault(); e.returnValue = ""; });
</script>
</body>
</html>
